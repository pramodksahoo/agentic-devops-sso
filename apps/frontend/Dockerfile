# Build stage
FROM node:20-alpine AS builder
WORKDIR /app

# Install pnpm
RUN npm install -g pnpm@8.15.0

# Copy package files
COPY package.json ./
COPY tsconfig.json ./
COPY tsconfig.node.json ./
COPY vite.config.ts ./
COPY tailwind.config.js ./
COPY postcss.config.js ./

# Install dependencies
RUN pnpm install

# Copy environment configuration
COPY .env ./

# Copy source code
COPY src/ ./src/
COPY index.html ./

# Define build-time environment variables
ARG VITE_FRONTEND_URL=http://localhost:3000
ARG VITE_AUTH_BFF_URL=http://localhost:3002
ARG VITE_API_BASE_URL=http://localhost:3002/api
ARG VITE_WS_URL=ws://localhost:3002
ARG VITE_USER_SERVICE_URL=http://localhost:3003
ARG VITE_TOOLS_SERVICE_URL=http://localhost:3004
ARG VITE_ADMIN_CONFIG_URL=http://localhost:3005
ARG VITE_CATALOG_URL=http://localhost:3006
ARG VITE_WEBHOOK_INGRESS_URL=http://localhost:3007
ARG VITE_AUDIT_URL=http://localhost:3009
ARG VITE_ANALYTICS_URL=http://localhost:3010
ARG VITE_PROVISIONING_URL=http://localhost:3011
ARG VITE_LDAP_SYNC_URL=http://localhost:3012
ARG VITE_POLICY_URL=http://localhost:3013
ARG VITE_NOTIFIER_URL=http://localhost:3014
ARG VITE_KEYCLOAK_URL=http://localhost:8080
ARG VITE_GRAFANA_URL=http://localhost:3100
ARG VITE_PROMETHEUS_URL=http://localhost:9090
ARG VITE_APP_TITLE=SSO Hub
ARG VITE_NODE_ENV=production
ARG VITE_DEBUG_MODE=false
ARG VITE_MOCK_API=false
ARG VITE_ENABLE_ANALYTICS=true
ARG VITE_ENABLE_AUDIT=true
ARG VITE_ENABLE_PROVISIONING=true
ARG VITE_ENABLE_LDAP_SYNC=true
ARG VITE_ENABLE_WEBHOOKS=true
ARG VITE_VERSION=1.0.0

# Set environment variables for build
ENV VITE_FRONTEND_URL=$VITE_FRONTEND_URL
ENV VITE_AUTH_BFF_URL=$VITE_AUTH_BFF_URL
ENV VITE_API_BASE_URL=$VITE_API_BASE_URL
ENV VITE_WS_URL=$VITE_WS_URL
ENV VITE_USER_SERVICE_URL=$VITE_USER_SERVICE_URL
ENV VITE_TOOLS_SERVICE_URL=$VITE_TOOLS_SERVICE_URL
ENV VITE_ADMIN_CONFIG_URL=$VITE_ADMIN_CONFIG_URL
ENV VITE_CATALOG_URL=$VITE_CATALOG_URL
ENV VITE_WEBHOOK_INGRESS_URL=$VITE_WEBHOOK_INGRESS_URL
ENV VITE_AUDIT_URL=$VITE_AUDIT_URL
ENV VITE_ANALYTICS_URL=$VITE_ANALYTICS_URL
ENV VITE_PROVISIONING_URL=$VITE_PROVISIONING_URL
ENV VITE_LDAP_SYNC_URL=$VITE_LDAP_SYNC_URL
ENV VITE_POLICY_URL=$VITE_POLICY_URL
ENV VITE_NOTIFIER_URL=$VITE_NOTIFIER_URL
ENV VITE_KEYCLOAK_URL=$VITE_KEYCLOAK_URL
ENV VITE_GRAFANA_URL=$VITE_GRAFANA_URL
ENV VITE_PROMETHEUS_URL=$VITE_PROMETHEUS_URL
ENV VITE_APP_TITLE=$VITE_APP_TITLE
ENV VITE_NODE_ENV=$VITE_NODE_ENV
ENV VITE_DEBUG_MODE=$VITE_DEBUG_MODE
ENV VITE_MOCK_API=$VITE_MOCK_API
ENV VITE_ENABLE_ANALYTICS=$VITE_ENABLE_ANALYTICS
ENV VITE_ENABLE_AUDIT=$VITE_ENABLE_AUDIT
ENV VITE_ENABLE_PROVISIONING=$VITE_ENABLE_PROVISIONING
ENV VITE_ENABLE_LDAP_SYNC=$VITE_ENABLE_LDAP_SYNC
ENV VITE_ENABLE_WEBHOOKS=$VITE_ENABLE_WEBHOOKS
ENV VITE_VERSION=$VITE_VERSION

# Build the React application
RUN pnpm run build

# Production stage
FROM node:20-alpine
WORKDIR /app

# Install serve to serve the built React app
RUN npm install -g serve

# Copy built application from builder stage
COPY --from=builder /app/dist ./dist

EXPOSE 3000
CMD ["serve", "-s", "dist", "-l", "3000"]
